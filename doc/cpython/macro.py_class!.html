<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <meta name="description" content="API documentation for the Rust `py_class!` macro in crate `cpython`.">
    <meta name="keywords" content="rust, rustlang, rust-lang, py_class!">

    <title>cpython::py_class! - Rust</title>

    <link rel="stylesheet" type="text/css" href="../rustdoc.css">
    <link rel="stylesheet" type="text/css" href="../main.css">
    

    
    
</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    

    <nav class="sidebar">
        
        <p class='location'><a href='index.html'>cpython</a></p><script>window.sidebarCurrent = {name: 'py_class!', ty: 'macro', relpath: ''};</script><script defer src="sidebar-items.js"></script>
    </nav>

    <nav class="sub">
        <form class="search-form js-only">
            <div class="search-container">
                <input class="search-input" name="search"
                       autocomplete="off"
                       placeholder="Click or press ‘S’ to search, ‘?’ for more options…"
                       type="search">
            </div>
        </form>
    </nav>

    <section id='main' class="content macro">
<h1 class='fqn'><span class='in-band'><a href='index.html'>cpython</a>::<wbr><a class='macro' href=''>py_class!</a></span><span class='out-of-band'><span id='render-detail'>
                   <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">
                       [<span class='inner'>&#x2212;</span>]
                   </a>
               </span><a id='src-4060' class='srclink' href='../src/cpython/src/py_class/py_class.rs.html#257-281' title='goto source code'>[src]</a></span></h1>
<pre class='rust macro'>
<span class='macro'>macro_rules</span><span class='macro'>!</span> <span class='ident'>py_class</span> {
    (<span class='ident'>class</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>class</span>:<span class='ident'>ident</span> <span class='op'>|</span><span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>py</span>: <span class='ident'>ident</span><span class='op'>|</span> { $( <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>body</span>:<span class='ident'>tt</span> )<span class='op'>*</span> }) <span class='op'>=&gt;</span> { ... };
}</pre>
<div class='docblock'><p>Defines new python extension class.
A <code>py_class!</code> macro invocation generates code that declares a new Python class.
Additionally, it generates a Rust struct of the same name, which allows accessing
instances of that Python class from Rust.</p>

<h1 id='syntax' class='section-header'><a href='#syntax'>Syntax</a></h1>
<p><code>py_class!(class MyType |py| { ... })</code></p>

<ul>
<li><code>MyType</code> is the name of the Python class.</li>
<li><code>py</code> is an identifier that will be made available as a variable of type <code>Python</code>
in all function bodies.</li>
<li><code>{ ... }</code> is the class body, described in more detail below.</li>
</ul>

<h1 id='example' class='section-header'><a href='#example'>Example</a></h1>
<pre class='rust rust-example-rendered'>
<span class='attribute'>#[<span class='ident'>macro_use</span>]</span> <span class='kw'>extern</span> <span class='kw'>crate</span> <span class='ident'>cpython</span>;
<span class='kw'>use</span> <span class='ident'>cpython</span>::{<span class='ident'>Python</span>, <span class='ident'>PyResult</span>, <span class='ident'>PyDict</span>};

<span class='macro'>py_class</span><span class='macro'>!</span>(<span class='ident'>class</span> <span class='ident'>MyType</span> <span class='op'>|</span><span class='ident'>py</span><span class='op'>|</span> {
    <span class='ident'>data</span> <span class='ident'>number</span>: <span class='ident'>i32</span>;
    <span class='ident'>def</span> <span class='ident'>__new__</span>(<span class='ident'>_cls</span>, <span class='ident'>arg</span>: <span class='ident'>i32</span>) <span class='op'>-&gt;</span> <span class='ident'>PyResult</span><span class='op'>&lt;</span><span class='ident'>MyType</span><span class='op'>&gt;</span> {
        <span class='ident'>MyType</span>::<span class='ident'>create_instance</span>(<span class='ident'>py</span>, <span class='ident'>arg</span>)
    }
    <span class='ident'>def</span> <span class='ident'>half</span>(<span class='kw-2'>&amp;</span><span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='ident'>PyResult</span><span class='op'>&lt;</span><span class='ident'>i32</span><span class='op'>&gt;</span> {
        <span class='macro'>println</span><span class='macro'>!</span>(<span class='string'>&quot;half() was called with self={:?}&quot;</span>, <span class='self'>self</span>.<span class='ident'>number</span>(<span class='ident'>py</span>));
        <span class='prelude-val'>Ok</span>(<span class='self'>self</span>.<span class='ident'>number</span>(<span class='ident'>py</span>) <span class='op'>/</span> <span class='number'>2</span>)
    }
});

<span class='kw'>fn</span> <span class='ident'>main</span>() {
    <span class='kw'>let</span> <span class='ident'>gil</span> <span class='op'>=</span> <span class='ident'>Python</span>::<span class='ident'>acquire_gil</span>();
    <span class='kw'>let</span> <span class='ident'>py</span> <span class='op'>=</span> <span class='ident'>gil</span>.<span class='ident'>python</span>();
    <span class='kw'>let</span> <span class='ident'>dict</span> <span class='op'>=</span> <span class='ident'>PyDict</span>::<span class='ident'>new</span>(<span class='ident'>py</span>);
    <span class='ident'>dict</span>.<span class='ident'>set_item</span>(<span class='ident'>py</span>, <span class='string'>&quot;MyType&quot;</span>, <span class='ident'>py</span>.<span class='ident'>get_type</span>::<span class='op'>&lt;</span><span class='ident'>MyType</span><span class='op'>&gt;</span>()).<span class='ident'>unwrap</span>();
    <span class='ident'>py</span>.<span class='ident'>run</span>(<span class='string'>&quot;assert MyType(42).half() == 21&quot;</span>, <span class='prelude-val'>None</span>, <span class='prelude-val'>Some</span>(<span class='kw-2'>&amp;</span><span class='ident'>dict</span>)).<span class='ident'>unwrap</span>();
}</pre>

<h1 id='generated-rust-type' class='section-header'><a href='#generated-rust-type'>Generated Rust type</a></h1>
<p>The above example generates the following Rust type:</p>

<pre class='rust rust-example-rendered'>
<span class='kw'>struct</span> <span class='ident'>MyType</span> { ... }

<span class='kw'>impl</span> <span class='ident'>ToPythonObject</span> <span class='kw'>for</span> <span class='ident'>MyType</span> { ... }
<span class='kw'>impl</span> <span class='ident'>PythonObject</span> <span class='kw'>for</span> <span class='ident'>MyType</span> { ... }
<span class='kw'>impl</span> <span class='ident'>PythonObjectWithCheckedDowncast</span> <span class='kw'>for</span> <span class='ident'>MyType</span> { ... }
<span class='kw'>impl</span> <span class='ident'>PythonObjectWithTypeObject</span> <span class='kw'>for</span> <span class='ident'>MyType</span> { ... }
<span class='kw'>impl</span> <span class='ident'>PythonObjectFromPyClassMacro</span> <span class='kw'>for</span> <span class='ident'>MyType</span> { ... }

<span class='kw'>impl</span> <span class='ident'>MyType</span> {
    <span class='kw'>fn</span> <span class='ident'>create_instance</span>(<span class='ident'>py</span>: <span class='ident'>Python</span>, <span class='ident'>number</span>: <span class='ident'>i32</span>) <span class='op'>-&gt;</span> <span class='ident'>PyResult</span><span class='op'>&lt;</span><span class='ident'>MyType</span><span class='op'>&gt;</span> { ... }

    <span class='comment'>// data accessors</span>
    <span class='kw'>fn</span> <span class='ident'>number</span><span class='op'>&lt;</span><span class='lifetime'>&#39;a</span><span class='op'>&gt;</span>(<span class='kw-2'>&amp;</span><span class='lifetime'>&#39;a</span> <span class='self'>self</span>, <span class='ident'>py</span>: <span class='ident'>Python</span><span class='op'>&lt;</span><span class='lifetime'>&#39;a</span><span class='op'>&gt;</span>) <span class='op'>-&gt;</span> <span class='kw-2'>&amp;</span><span class='lifetime'>&#39;a</span> <span class='ident'>i32</span> { ... }

    <span class='comment'>// functions callable from python</span>
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>__new__</span>(<span class='ident'>_cls</span>: <span class='kw-2'>&amp;</span><span class='ident'>PyType</span>, <span class='ident'>py</span>: <span class='ident'>Python</span>, <span class='ident'>arg</span>: <span class='ident'>i32</span>) <span class='op'>-&gt;</span> <span class='ident'>PyResult</span><span class='op'>&lt;</span><span class='ident'>MyType</span><span class='op'>&gt;</span> {
        <span class='ident'>MyType</span>::<span class='ident'>create_instance</span>(<span class='ident'>py</span>, <span class='ident'>arg</span>)
    }

    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>half</span>(<span class='kw-2'>&amp;</span><span class='self'>self</span>, <span class='ident'>py</span>: <span class='ident'>Python</span>) <span class='op'>-&gt;</span> <span class='ident'>PyResult</span><span class='op'>&lt;</span><span class='ident'>i32</span><span class='op'>&gt;</span> {
        <span class='macro'>println</span><span class='macro'>!</span>(<span class='string'>&quot;half() was called with self={:?}&quot;</span>, <span class='self'>self</span>.<span class='ident'>number</span>(<span class='ident'>py</span>));
        <span class='prelude-val'>Ok</span>(<span class='self'>self</span>.<span class='ident'>number</span>(<span class='ident'>py</span>) <span class='op'>/</span> <span class='number'>2</span>)
    }
}</pre>

<ul>
<li>The generated type implements a number of traits from the <code>cpython</code> crate.</li>
<li>The inherent <code>create_instance</code> method can create new Python objects
given the values for the data fields.</li>
<li>Private accessors functions are created for the data fields.</li>
<li>All functions callable from Python are also exposed as public Rust functions.</li>
<li>To convert from <code>MyType</code> to <code>PyObject</code>, use <code>as_object()</code> or <code>into_object()</code> (from the <code>PythonObject</code> trait).</li>
<li>To convert <code>PyObject</code> to <code>MyType</code>, use <code>obj.cast_as::&lt;MyType&gt;(py)</code> or <code>obj.cast_into::&lt;MyType&gt;(py)</code>.</li>
</ul>

<h1 id='py_class-body' class='section-header'><a href='#py_class-body'>py_class body</a></h1>
<p>The body of a <code>py_class!</code> supports the following definitions:</p>

<h2 id='data-declarations' class='section-header'><a href='#data-declarations'>Data declarations</a></h2>
<p><code>data data_name: data_type;</code></p>

<p>Declares a data field within the Python class.
Used to store Rust data directly in the Python object instance.</p>

<p>Because Python code can pass all Python objects to other threads,
<code>data_type</code> must be <code>Send + &#39;static</code>.</p>

<p>Because Python object instances can be freely shared (Python has no concept of &quot;ownership&quot;),
data fields cannot be declared as <code>mut</code>.
If mutability is required, you have to use interior mutability (<code>Cell</code> or <code>RefCell</code>).</p>

<p>If data members are used to store references to other Python objects, make sure
to read the section &quot;Garbage Collector Integration&quot;.</p>

<p>Data declarations are not accessible from Python.
On the Rust side, data is accessed through the automatically generated accessor functions:
<code>ignore impl MyType { fn data_name&lt;&#39;a&gt;(&amp;&#39;a self, py: Python&lt;&#39;a&gt;) -&gt; &amp;&#39;a data_type { ... } }</code></p>

<h2 id='instance-methods' class='section-header'><a href='#instance-methods'>Instance methods</a></h2>
<p><code>def method_name(&amp;self, parameter-list) -&gt; PyResult&lt;...&gt; { ... }</code></p>

<p>Declares an instance method callable from Python.</p>

<ul>
<li>Because Python objects are potentially shared, the self parameter must always
be a shared reference (<code>&amp;self</code>).</li>
<li>For details on <code>parameter-list</code>, see the documentation of <code>py_argparse!()</code>.</li>
<li>The return type must be <code>PyResult&lt;T&gt;</code> for some <code>T</code> that implements <code>ToPyObject</code>.</li>
</ul>

<h2 id='class-methods' class='section-header'><a href='#class-methods'>Class methods</a></h2>
<p>`@classmethod def method_name(cls, parameter-list) -&gt; PyResult&lt;...&gt; { ... }</p>

<p>Declares a class method callable from Python.</p>

<ul>
<li>The first parameter is the type object of the class on which the method is called.
This may be the type object of a derived class.</li>
<li>The first parameter implicitly has type <code>&amp;PyType</code>. This type must not be explicitly specified.</li>
<li>For details on <code>parameter-list</code>, see the documentation of <code>py_argparse!()</code>.</li>
<li>The return type must be <code>PyResult&lt;T&gt;</code> for some <code>T</code> that implements <code>ToPyObject</code>.</li>
</ul>

<h2 id='static-methods' class='section-header'><a href='#static-methods'>Static methods</a></h2>
<p>`@staticmethod def method_name(parameter-list) -&gt; PyResult&lt;...&gt; { ... }</p>

<p>Declares a static method callable from Python.</p>

<ul>
<li>For details on <code>parameter-list</code>, see the documentation of <code>py_argparse!()</code>.</li>
<li>The return type must be <code>PyResult&lt;T&gt;</code> for some <code>T</code> that implements <code>ToPyObject</code>.</li>
</ul>

<h2 id='new' class='section-header'><a href='#new'><strong>new</strong></a></h2>
<p><code>def __new__(cls, parameter-list) -&gt; PyResult&lt;...&gt; { ... }</code></p>

<p>Declares a constructor method callable from Python.</p>

<ul>
<li>If no <code>__new__</code> method is declared, object instances can only be created from Rust (via <code>MyType::create_instance</code>),
but not from Python.</li>
<li>The first parameter is the type object of the class to create.
This may be the type object of a derived class declared in Python.</li>
<li>The first parameter implicitly has type <code>&amp;PyType</code>. This type must not be explicitly specified.</li>
<li>For details on <code>parameter-list</code>, see the documentation of <code>py_argparse!()</code>.</li>
<li>The return type must be <code>PyResult&lt;T&gt;</code> for some <code>T</code> that implements <code>ToPyObject</code>.
Usually, <code>T</code> will be <code>MyType</code>.</li>
</ul>

<h2 id='garbage-collector-integration' class='section-header'><a href='#garbage-collector-integration'>Garbage Collector Integration</a></h2>
<p>If your type owns references to other python objects, you will need to
integrate with Python&#39;s garbage collector so that the GC is aware of
those references.
To do this, implement the special member functions <code>__traverse__</code> and <code>__clear__</code>.
These correspond to the slots <code>tp_traverse</code> and <code>tp_clear</code> in the Python C API.</p>

<p><code>__traverse__</code> must call <code>visit.call()</code> for each reference to another python object.</p>

<p><code>__clear__</code> must clear out any mutable references to other python objects
(thus breaking reference cycles). Immutable references do not have to be cleared,
as every cycle must contain at least one mutable reference.</p>

<p>Example:</p>

<pre class='rust rust-example-rendered'>
<span class='attribute'>#[<span class='ident'>macro_use</span>]</span> <span class='kw'>extern</span> <span class='kw'>crate</span> <span class='ident'>cpython</span>;
<span class='kw'>use</span> <span class='ident'>std</span>::{<span class='ident'>mem</span>, <span class='ident'>cell</span>};
<span class='kw'>use</span> <span class='ident'>cpython</span>::{<span class='ident'>PyObject</span>, <span class='ident'>PyDrop</span>};

<span class='macro'>py_class</span><span class='macro'>!</span>(<span class='ident'>class</span> <span class='ident'>ClassWithGCSupport</span> <span class='op'>|</span><span class='ident'>py</span><span class='op'>|</span> {
    <span class='ident'>data</span> <span class='ident'>obj</span>: <span class='ident'>cell</span>::<span class='ident'>RefCell</span><span class='op'>&lt;</span><span class='prelude-ty'>Option</span><span class='op'>&lt;</span><span class='ident'>PyObject</span><span class='op'>&gt;&gt;</span>;

    <span class='ident'>def</span> <span class='ident'>__traverse__</span>(<span class='kw-2'>&amp;</span><span class='self'>self</span>, <span class='ident'>visit</span>) {
        <span class='kw'>if</span> <span class='kw'>let</span> <span class='prelude-val'>Some</span>(<span class='kw-2'>ref</span> <span class='ident'>obj</span>) <span class='op'>=</span> <span class='op'>*</span><span class='self'>self</span>.<span class='ident'>obj</span>(<span class='ident'>py</span>).<span class='ident'>borrow</span>() {
            <span class='macro'>try</span><span class='macro'>!</span>(<span class='ident'>visit</span>.<span class='ident'>call</span>(<span class='ident'>obj</span>))
        }
        <span class='prelude-val'>Ok</span>(())
    }

    <span class='ident'>def</span> <span class='ident'>__clear__</span>(<span class='kw-2'>&amp;</span><span class='self'>self</span>) {
        <span class='kw'>let</span> <span class='ident'>old_obj</span> <span class='op'>=</span> <span class='ident'>mem</span>::<span class='ident'>replace</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='op'>*</span><span class='self'>self</span>.<span class='ident'>obj</span>(<span class='ident'>py</span>).<span class='ident'>borrow_mut</span>(), <span class='prelude-val'>None</span>);
        <span class='comment'>// Release reference only after the mutable borrow has expired,</span>
        <span class='comment'>// see Caution note below.</span>
        <span class='ident'>old_obj</span>.<span class='ident'>release_ref</span>(<span class='ident'>py</span>);
    }
});</pre>

<p>Caution: <code>__traverse__</code> may be called by the garbage collector:
  * during any python operation that takes a <code>Python</code> token as argument
  * indirectly from the <code>PyObject</code> (or derived type) <code>Drop</code> implementation
  * if your code releases the GIL, at any time by other threads.</p>

<p>If you are using <code>RefCell&lt;PyObject&gt;</code>, you must not perform any of the above
operations while your code holds a mutable borrow, or you may cause the borrow
in <code>__traverse__</code> to panic.</p>

<p>This is why the example above uses the <code>mem::replace</code>/<code>release_ref</code> dance:
<code>release_ref</code> (or the implicit <code>Drop</code>) can only be called safely in a separate
statement, after the mutable borrow on the <code>RefCell</code> has expired.</p>

<p>Note that this restriction applies not only to <code>__clear__</code>, but to all methods
that use <code>RefCell::borrow_mut</code>.</p>

<h2 id='iterator-types' class='section-header'><a href='#iterator-types'>Iterator Types</a></h2>
<p>Iterators can be defined using the Python special methods <code>__iter__</code> and <code>__next__</code>:</p>

<ul>
<li><code>def __iter__(&amp;self) -&gt; PyResult&lt;T&gt;</code></li>
<li><code>def __next__(&amp;self) -&gt; PyResult&lt;Option&lt;T&gt;&gt;</code></li>
</ul>

<p>In both cases, <code>T</code> must be a type that implements <code>ToPyObject</code>.
Returning <code>Ok(None)</code> from <code>__next__</code> indicates that that there are no further items.</p>

<p>Example:</p>

<pre class='rust rust-example-rendered'>
<span class='attribute'>#[<span class='ident'>macro_use</span>]</span> <span class='kw'>extern</span> <span class='kw'>crate</span> <span class='ident'>cpython</span>;
<span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>cell</span>::<span class='ident'>RefCell</span>;
<span class='kw'>use</span> <span class='ident'>cpython</span>::{<span class='ident'>PyObject</span>, <span class='ident'>PyClone</span>, <span class='ident'>PyResult</span>};

<span class='macro'>py_class</span><span class='macro'>!</span>(<span class='ident'>class</span> <span class='ident'>MyIterator</span> <span class='op'>|</span><span class='ident'>py</span><span class='op'>|</span> {
    <span class='ident'>data</span> <span class='ident'>iter</span>: <span class='ident'>RefCell</span><span class='op'>&lt;</span><span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>Iterator</span><span class='op'>&lt;</span><span class='ident'>Item</span><span class='op'>=</span><span class='ident'>PyObject</span><span class='op'>&gt;</span> <span class='op'>+</span> <span class='ident'>Send</span><span class='op'>&gt;&gt;</span>;

    <span class='ident'>def</span> <span class='ident'>__iter__</span>(<span class='kw-2'>&amp;</span><span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='ident'>PyResult</span><span class='op'>&lt;</span><span class='kw'>Self</span><span class='op'>&gt;</span> {
        <span class='prelude-val'>Ok</span>(<span class='self'>self</span>.<span class='ident'>clone_ref</span>(<span class='ident'>py</span>))
    }

    <span class='ident'>def</span> <span class='ident'>__next__</span>(<span class='kw-2'>&amp;</span><span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='ident'>PyResult</span><span class='op'>&lt;</span><span class='prelude-ty'>Option</span><span class='op'>&lt;</span><span class='ident'>PyObject</span><span class='op'>&gt;&gt;</span> {
        <span class='prelude-val'>Ok</span>(<span class='self'>self</span>.<span class='ident'>iter</span>(<span class='ident'>py</span>).<span class='ident'>borrow_mut</span>().<span class='ident'>next</span>())
    }
});</pre>
</div></section>
    <section id='search' class="content hidden"></section>

    <section class="footer"></section>

    <aside id="help" class="hidden">
        <div>
            <h1 class="hidden">Help</h1>

            <div class="shortcuts">
                <h2>Keyboard Shortcuts</h2>

                <dl>
                    <dt>?</dt>
                    <dd>Show this help dialog</dd>
                    <dt>S</dt>
                    <dd>Focus the search field</dd>
                    <dt>&larrb;</dt>
                    <dd>Move up in search results</dd>
                    <dt>&rarrb;</dt>
                    <dd>Move down in search results</dd>
                    <dt>&#9166;</dt>
                    <dd>Go to active search result</dd>
                </dl>
            </div>

            <div class="infos">
                <h2>Search Tricks</h2>

                <p>
                    Prefix searches with a type followed by a colon (e.g.
                    <code>fn:</code>) to restrict the search to a given type.
                </p>

                <p>
                    Accepted types are: <code>fn</code>, <code>mod</code>,
                    <code>struct</code>, <code>enum</code>,
                    <code>trait</code>, <code>type</code>, <code>macro</code>,
                    and <code>const</code>.
                </p>

                <p>
                    Search functions by type signature (e.g.
                    <code>vec -> usize</code> or <code>* -> vec</code>)
                </p>
            </div>
        </div>
    </aside>

    

    <script>
        window.rootPath = "../";
        window.currentCrate = "cpython";
        window.playgroundUrl = "";
    </script>
    <script src="../jquery.js"></script>
    <script src="../main.js"></script>
    
    <script defer src="../search-index.js"></script>
</body>
</html>